<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Talent Opportunity Index</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .green { background-color: #c8e6c9; }
    .yellow { background-color: #fff9c4; }
    .red { background-color: #ffcdd2; }
    .actions button { margin-right: 5px; }
  </style>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
</head>
<body>
  <h1>Talent Opportunity Index</h1>
  <div id="root"></div>
  <script type="text/babel">
    const api = '/api/entries';

    function toi(entry) {
      const demand = parseFloat(entry.demand);
      const supply = parseFloat(entry.supply);
      const modifier = parseFloat(entry.modifier);
      if (!demand) return 0;
      return ((supply / demand) * modifier).toFixed(2);
    }

    function color(score) {
      if (score > 5) return 'green';
      if (score >= 2) return 'yellow';
      return 'red';
    }

    function EntryForm({initial, onSave, onCancel}) {
      const [form, setForm] = React.useState({...initial});
      const update = e => setForm({...form, [e.target.name]: e.target.value});
      const handleSubmit = e => { e.preventDefault(); onSave(form); };
      return (
        <form onSubmit={handleSubmit}>
          <input name="role" value={form.role} onChange={update} placeholder="Role" required/>
          <input name="city" value={form.city} onChange={update} placeholder="City" required/>
          <input name="demand" type="number" value={form.demand} onChange={update} placeholder="Demand" required/>
          <input name="supply" type="number" value={form.supply} onChange={update} placeholder="Supply" required/>
          <input name="modifier" type="number" step="0.1" value={form.modifier} onChange={update} placeholder="Modifier" required/>
          <button type="submit">Save</button>
          {onCancel && <button type="button" onClick={onCancel}>Cancel</button>}
        </form>
      );
    }

    function App() {
      const [entries, setEntries] = React.useState([]);
      const [editing, setEditing] = React.useState(null);

      React.useEffect(() => {
        fetch(api).then(r => r.json()).then(setEntries);
      }, []);

      const addEntry = data =>
        fetch(api, {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)})
        .then(r => r.json()).then(e => setEntries([...entries, e]));

      const updateEntry = (id, data) =>
        fetch(api + '/' + id, {method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)})
        .then(r => r.json()).then(e => setEntries(entries.map(en => en.id === id ? e : en)));

      const deleteEntry = id =>
        fetch(api + '/' + id, {method: 'DELETE'}).then(r => r.json())
        .then(() => setEntries(entries.filter(e => e.id !== id)));

      return (
        <div>
          <h2>Add Entry</h2>
          <EntryForm initial={{role:'', city:'', demand:'', supply:'', modifier:'1'}} onSave={addEntry}/>
          <h2>Entries</h2>
          <table>
            <thead>
              <tr>
                <th>Role</th>
                <th>City</th>
                <th>Job Postings</th>
                <th>Available Talent</th>
                <th>Market Modifier</th>
                <th>TOI Score</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {entries.map(e => editing === e.id ? (
                <tr key={e.id}>
                  <td colSpan="7">
                    <EntryForm initial={e}
                      onSave={data => { updateEntry(e.id, data); setEditing(null); }}
                      onCancel={() => setEditing(null)}
                    />
                  </td>
                </tr>
              ) : (
                <tr key={e.id}>
                  <td>{e.role}</td>
                  <td>{e.city}</td>
                  <td>{e.demand}</td>
                  <td>{e.supply}</td>
                  <td>{e.modifier}</td>
                  <td className={color(toi(e))}>{toi(e)}</td>
                  <td className="actions">
                    <button onClick={() => setEditing(e.id)}>Edit</button>
                    <button onClick={() => deleteEntry(e.id)}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
